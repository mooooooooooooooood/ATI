<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS Speaking Results Analysis</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        /* Custom font and base styling */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* Custom styles for assessment text formatting */
        .assessment-text {
            white-space: pre-wrap; /* Ensures paragraphs and newlines from the JSON are respected */
            line-height: 1.6;
            font-size: 0.95rem;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

<div class="max-w-4xl mx-auto bg-white shadow-2xl rounded-xl p-6 md:p-10 border-t-4 border-indigo-600">
    <header class="text-center pb-6 border-b border-gray-100">
        <h1 class="text-3xl md:text-4xl font-extrabold text-gray-800">
            AI IELTS Speaking Evaluation ðŸ¤–
        </h1>
        <p class="text-lg text-indigo-600 mt-2">Detailed Breakdown & Feedback</p>
    </header>

    <!-- Overall Score Section -->
    <section id="overall-score-section" class="text-center py-8 bg-indigo-50/50 rounded-lg mt-6 shadow-inner">
        <h2 class="text-xl font-semibold text-gray-600">Overall Band Score</h2>
        <div id="overall-band" class="text-7xl font-black text-indigo-700 mt-2">
            --
        </div>
        <p class="text-sm text-gray-500 mt-1">Achieved in Speaking Practice</p>
    </section>

    <!-- Detailed Criteria Grid -->
    <section class="mt-10">
        <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">Criterion Breakdown</h2>
        <div id="criteria-container" class="space-y-8">
            <!-- Results will be injected here -->
        </div>
    </section>

    <!-- Raw JSON Data (Hidden) -->
    <script id="raw-json-data" type="application/json">
        {"message":"{\nÂ  \"overall_band\": 6.0,\nÂ  \"fluency_and_coherence\": {\nÂ  Â  \"band\": 7.0,\nÂ  Â  \"assessment\": \"The candidate's fluency is good, but there are moments where she struggles to maintain a consistent pace. She occasionally uses filler words such as 'um' and 'like'. Her vocabulary is decent, and she uses a range of words to express herself.\n\nA notable example is a long, run-on explanation where she describes how her mother began with a modeling job, later became a director of finance, built office buildings and a house by herself, and succeeded despite lacking a formal educational background. She continues to elaborate that her mother is knowledgeable, opinionated, assertive, and highly inspiring. She also describes her motherâ€™s difficult childhood during the war in Sri Lanka, her resilience, her achievements, and her dedication as a working mother who remained heavily involved in her childrenâ€™s upbringing.\n\nWhile coherent, the long, uninterrupted stretches of speech reduce clarity and make the answer sound less controlled.\"\n\nÂ  Â  },\nÂ  \"lexical_resource\": {\nÂ  Â  \"band\": 6.0,\nÂ  Â  \"assessment\": \"The candidate demonstrates adequate vocabulary but often relies on general or repetitive expressions. A large portion of her response consists of a long, unstructured narrative with repeated phrases such as'she started','she built','she made sure', and'she never let anything stop her'.\n\nDespite demonstrating admiration effectively, the language lacks precision and relies heavily on everyday expressions. More topic-specific vocabulary, paraphrasing, and a wider lexical range would strengthen her score.\"\n\nÂ  Â  },\nÂ  \"grammatical_range_accuracy\": {\nÂ  Â  \"band\": 6.5,\nÂ  Â  \"assessment\": \"The candidate uses mostly simple or loosely connected sentence structures. Much of her response is one extended run-on sentence linked by 'and', 'but', and'so'. Although grammar is generally understandable, the lack of controlled complex structures limits accuracy.\n\nSome clauses are repeated or blended together without punctuation, reducing clarity. More varied sentence forms and clearer segmentation would improve grammatical control.\"\n\nÂ  Â  },\nÂ  \"pronunciation\": {\nÂ  Â  \"band\": 6.0,\nÂ  Â  \"assessment\": \"The candidate's pronunciation is generally understandable, though she occasionally struggles with articulation and rhythm. Some words are slightly unclear, and connected speech sometimes becomes muddled due to long, uninterrupted sentences. However, her accent is intelligible, and meaning remains clear.\n\nShe also uses a mildly formal tone, which aligns with her speaking style. Improved articulation, pausing, and intonation control would help raise her score.\"\n\nÂ  Â  }\n}"}
    </script>
</div>

<script>
    // Mapping from JSON key to display name
    const CRITERIA_MAP = {
        'fluency_and_coherence': 'Fluency and Coherence',
        'lexical_resource': 'Lexical Resource',
        'grammatical_range_accuracy': 'Grammatical Range and Accuracy',
        'pronunciation': 'Pronunciation'
    };

    function parseAndRenderResults() {
        const rawJsonElement = document.getElementById('raw-json-data');
        const rawJsonText = rawJsonElement.textContent;

        let parsedOuter;
        let innerJsonString;
        let finalGradingMap;

        try {
            // Step 1: Parse the outer JSON
            parsedOuter = JSON.parse(rawJsonText);

            // Step 2: Extract the inner JSON string from the 'message' field
            innerJsonString = parsedOuter.message;

            // Step 3: Sanitize the inner string (replace illegal newlines with the escape sequence)
            // This is crucial because the API provided literal \n characters inside the JSON string values.
            // We also replace non-breaking space characters which appear in the raw output.
            innerJsonString = innerJsonString
                .replace(/\n/g, '\\n') // Replace literal newline with JSON escape sequence
                .replace(/\r/g, '\\r') // Replace literal carriage return with JSON escape sequence
                .replace(/\xA0/g, ' '); // Replace non-breaking space (code 160)

            // The string might still contain extra escaped backslashes in the assessment text
            // that look like \\n in the source, but are intended to be \n in the final output.
            // We run a final clean-up to ensure double escapes are not accidentally introduced
            // if the API partially escaped. For this specific output, the above replace should be sufficient.

            // Step 4: Parse the cleaned inner JSON string
            finalGradingMap = JSON.parse(innerJsonString);

        } catch (e) {
            console.error("Error parsing JSON:", e);
            document.getElementById('criteria-container').innerHTML = `
                <div class="p-6 bg-red-100 text-red-700 border-l-4 border-red-500 rounded-lg">
                    <h3 class="font-bold">Parsing Error</h3>
                    <p>Could not process the server's response due to invalid JSON formatting.</p>
                    <p class="mt-2 text-sm text-red-500">Error details: \${e.message}</p>
                </div>
            `;
            return;
        }

        // --- Render Overall Score ---
        const overallBand = finalGradingMap.overall_band ? finalGradingMap.overall_band.toFixed(1) : 'N/A';
        document.getElementById('overall-band').textContent = overallBand;

        // --- Render Detailed Criteria ---
        const container = document.getElementById('criteria-container');
        container.innerHTML = ''; // Clear container

        Object.keys(CRITERIA_MAP).forEach((key, index) => {
            const criteriaData = finalGradingMap[key];
            if (!criteriaData) return;

            const criteriaTitle = CRITERIA_MAP[key];
            const bandScore = criteriaData.band ? criteriaData.band.toFixed(1) : 'N/A';
            const assessmentText = criteriaData.assessment || 'No detailed assessment provided.';

            const criteriaHtml = `
                <div class="p-6 bg-white rounded-xl shadow-lg border border-gray-100 transition duration-300 hover:shadow-xl">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-semibold text-gray-800">${index + 1}. ${criteriaTitle}</h3>
                        <div class="text-3xl font-bold text-green-600 bg-green-50 px-4 py-1 rounded-full shadow-md">
                            ${bandScore}
                        </div>
                    </div>
                    <h4 class="text-md font-medium text-gray-600 mt-4 mb-2 border-t pt-3">Detailed Assessment:</h4>
                    <div class="assessment-text text-gray-700 bg-gray-50 p-4 rounded-lg">
                        ${assessmentText.replace(/\\n/g, '<br><br>')}
                    </div>
                </div>
            `;
            container.innerHTML += criteriaHtml;
        });
    }

    // Run the rendering function when the window loads
    window.onload = parseAndRenderResults;
</script>

</body>
</html>