<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" th:href="@{/css/header.css}">
</head>
<body>
    <!-- Header Fragment -->
    <header th:fragment="header" class="site-header">
        <div class="container">
            <div class="header-content">
                <!-- Logo -->
                <div class="logo">
                    <a href="/">
                        <img th:src="@{/images/Logo ATI.png}" alt="IELTS AI">
                    </a>
                </div>

                <!-- Navigation -->
                <nav class="main-nav">
                    <ul>
                        <li><a href="/">Home</a></li>
                        <li class="dropdown">
                            <button type="button" class="dropdown-toggle">
                                <span>IELTS Online Test</span>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="chevron-icon">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a th:href="${session.loggedInUser != null ? '/test/writing' : '/require-login?redirect=/test/writing'}">Writing Tests</a></li>
                                <li><a th:href="${session.loggedInUser != null ? '/test/listening' : '/require-login?redirect=/test/listening'}">Listening Tests</a></li>
                                <li><a th:href="${session.loggedInUser != null ? '/test/speaking' : '/require-login?redirect=/test/speaking'}">Speaking Tests</a></li>
                                <li><a th:href="${session.loggedInUser != null ? '/test/reading' : '/require-login?redirect=/test/reading'}">Reading Tests</a></li>
                            </ul>
                        </li>
                    </ul>
                </nav>

                <!-- Search Bar -->
                <div class="header-search">
                    <form action="/search" method="get">
                        <input type="text" name="q" placeholder="Search ...">
                        <button type="submit">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"></circle>
                                <path d="m21 21-4.35-4.35"></path>
                            </svg>
                        </button>
                    </form>
                </div>

                <!-- User Actions -->
                <div class="header-actions">
                    <!-- Guest: Show Sign In and Sign Up buttons -->
                    <div th:if="${session.loggedInUser == null}" class="guest-actions">
                        <a href="/user/login" class="btn btn-signin">Sign In</a>
                        <a href="/user/signup" class="btn btn-signup">Sign Up</a>
                    </div>
                   
                    <!-- Logged In: Show User Menu -->
                    <div th:if="${session.loggedInUser != null}" class="user-menu">
                        <button class="user-menu-toggle" type="button">
                            <img th:src="${session.loggedInUser.avatar != null ? session.loggedInUser.avatar : '/images/default-avatar.png'}"
                                 alt="User Avatar"
                                 class="user-avatar">
                            <span th:text="${session.loggedInUser.name}">User</span>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="chevron-icon">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </button>
                       
                        <ul class="user-dropdown">
                            <li><a href="/dashboard">Dashboard</a></li>
                            <li><a href="/user/profile">My Profile</a></li>
                            <li><a href="/test/list">My Tests</a></li>
                            <li class="divider"></li>
                            <li><a href="/user/logout">Logout</a></li>
                        </ul>
                    </div>
                </div>        
            </div>
        </div>
    </header>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Dropdown "IELTS Online Test" toggle
            const dropdownToggle = document.querySelector('.dropdown-toggle');
            const dropdown = document.querySelector('.dropdown');
            
            if (dropdownToggle && dropdown) {
                dropdownToggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    dropdown.classList.toggle('active');
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', function(e) {
                    if (!dropdown.contains(e.target)) {
                        dropdown.classList.remove('active');
                    }
                });

                // Prevent dropdown from closing when clicking inside menu
                const dropdownMenu = dropdown.querySelector('.dropdown-menu');
                if (dropdownMenu) {
                    dropdownMenu.addEventListener('click', function(e) {
                        // Allow navigation to links
                        if (e.target.tagName === 'A') {
                            dropdown.classList.remove('active');
                        }
                    });
                }
            }

            // User menu toggle
            const userMenuToggle = document.querySelector('.user-menu-toggle');
            const userMenu = document.querySelector('.user-menu');
            
            if (userMenuToggle && userMenu) {
                userMenuToggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    userMenu.classList.toggle('active');
                });

                // Close user menu when clicking outside
                document.addEventListener('click', function(e) {
                    if (!userMenu.contains(e.target)) {
                        userMenu.classList.remove('active');
                    }
                });

                // Close user menu when clicking a link
                const userDropdown = userMenu.querySelector('.user-dropdown');
                if (userDropdown) {
                    userDropdown.addEventListener('click', function(e) {
                        if (e.target.tagName === 'A') {
                            userMenu.classList.remove('active');
                        }
                    });
                }
            }
        });
    </script>
</body>
</html>